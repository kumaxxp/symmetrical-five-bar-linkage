# Symmetrical Five-Bar Linkage

## 概要

このドキュメントでは、前後対称な五節リンクの設計について説明します。以下の図は、五節リンクのコンポーネントとその接続を示しています。

## PlantUMLコード

以下は、前後対称な五節リンクを示すPlantUMLコードです。

``` plantuml
@startuml

skin rose

component [B2 モーター付き] as B2
component [B1 モーター付き] as B1
component [M1 ] as M1
component [X ] as X
component [M2 ] as M2
component [E エンドエフェクタ] as E

B2 -r[hidden]-> B1
B1 -d[hidden]-> M1
M1 -d[hidden]-> X
B2 -d[hidden]-> M2
X -d[hidden]-> E

B1 -r- B2:l

B1 -d- M1:b
B2 -d- M2:b
M1 -d- X:m
M2 -d- X:m
X -d- E:e
@enduml

```

---

順運動学における計算式を以下にまとめます。これにより、五節リンクの各点の位置を計算できます。以下の計算式を順番に適用して、各点の座標を求めます。


# 順運動学の設計

初期値として以下の数値が設定される。

- \( y = Y_b \)  の直線上に、B1,B2を配置する
- \( l \) は B2-B1 のリンク長
- \( b \) は B1-M1 および B2-M2 のリンク長
- \( m \) は M1-X および M2-X のリンク長
- \( e \) は X-E のリンク長
- \( \theta1 \) は B1-M1 の角度
- \( \theta2 \) は B2-M2 の角度

**点 \( B1 \) と \( B2 \) の座標** は初期値で決定します。

   - \( B1 = \left(\frac{l}{2}, Y_b\right) \)
   - \( B2 = \left(-\frac{l}{2}, Y_b\right) \)



## 1. 点 \( M1 \) と \( M2 \) の計算


**点 \( M1 \) と \( M2 \) の座標** は以下の式で計算されます。

- \(M1 = B1 + [b \cdot \cos(\theta1), b \cdot \sin(\theta1)]\)
- \(M2 = B2 + [b \cdot \cos(\theta2), b \cdot \sin(\theta2)]\)

ここで、
- \( \theta1 \) は B1-M1 の角度
- \( \theta2 \) は B2-M2 の角度
- \( b \) は B1-M1 および B2-M2 のリンク長

## 2. 点 X の計算
点 X の座標は、M1 および M2 の位置から、2つの円の交点として求められます。

円の中心間距離 \( d \) は以下の式で計算します。
- \( d = \|M1 - M2\| \)

交点の計算式は以下の通りです。
- \( a = \frac{r1^2 - r2^2 + d^2}{2d} \)
- \( h = \sqrt{r1^2 - a^2} \)
- \( x0 = x1 + \frac{a \cdot (x2 - x1)}{d} \)
- \( y0 = y1 + \frac{a \cdot (y2 - y1)}{d} \)
- \( X1 = [x0 + \frac{h \cdot (y2 - y1)}{d}, y0 - \frac{h \cdot (x2 - x1)}{d}] \)
- \( X2 = [x0 - \frac{h \cdot (y2 - y1)}{d}, y0 + \frac{h \cdot (x2 - x1)}{d}] \)

X1とX2のどちらをXとして採用するかは、凸形状の判定で決定する。

## 3. 凸形状の判定
凸多角形の判定には、以下の外積を利用します。

- 外積 = \( (b_x - a_x) \cdot (c_y - b_y) - (b_y - a_y) \cdot (c_x - b_x) \)

外積が正であれば凹形状と判定します。

## 4. エンドエフェクタの点 \( E \) の計算
エンドエフェクタの点 \( E \) の位置は、点 \( X \) から長さ \( e \) の距離にあり、直線 \( M1-X \) 上の点として計算します。

1. **直線 \( M1-X \) の方程式を求める**
   - 直線の傾き \( m \) は次の式で計算します。
     - \( m = \frac{X_y - M1_y}{X_x - M1_x} \)
   - 直線の方程式は \( y - M1_y = m \cdot (x - M1_x) \) です。

2. **直線 \( M1-X \) 上の点を計算**
   - 点 \( E \) の座標は次の式で計算します。
     - \( E_x = X_x + e \cdot \frac{M1_y - X_y}{\sqrt{(M1_x - X_x)^2 + (M1_y - X_y)^2}} \)
     - \( E_y = X_y + e \cdot \frac{X_x - M1_x}{\sqrt{(M1_x - X_x)^2 + (M1_y - X_y)^2}} \)

## 注意事項
- 点 X の選定は、凸形状の条件を満たすかどうかで決定します。
- 凸多角形でない場合、エラーメッセージが表示されます。
- 点 \( E \) の位置は直線 \( M1-X \) 上にあり、長さ \( e \) の距離だけ \( X \) から離れた位置にあります。

---

エンドエフェクタの点 \( E \) の位置は、点 \( X \) から長さ \( e \) の距離にあり、直線 \( M1-X \) 上の点として計算します。

1. **直線 \( M1-X \) の方程式を求める**

- 点 \( M1 = (M1_x, M1_y) \)
- 点 \( X = (X_x, X_y) \)

直線の方程式を計算するために、直線の方向ベクトルを求めます。

   \(
   \text{方向ベクトル} \ \mathbf{d} = X - M1 = (X_x - M1_x, X_y - M1_y)
   \)

2. **直線 \( M1-X \) の単位ベクトルを計算**

- 方向ベクトルの長さ（ノルム）は
     \(
     \text{norm} = \sqrt{(X_x - M1_x)^2 + (X_y - M1_y)^2}
     \)

- 単位ベクトルは
     \(
     \text{unit\_vector} = \left(\frac{X_x - M1_x}{\text{norm}}, \frac{X_y - M1_y}{\text{norm}}\right)
     \)

3. **点 \( E \) の座標を計算**

 + \( E_x = X_x + e \cdot \frac{X_x - M1_x}{\text{norm}} \)
 + \( E_y = X_y + e \cdot \frac{X_y - M1_y}{\text{norm}} \)



---

# 逆運動学の設計

初期値として以下の数値が設定される。

- \( y = Y_b \)  の直線上に、B1,B2を配置する
- \( l \) は B2-B1 のリンク長
- \( b \) は B1-M1 および B2-M2 のリンク長
- \( m \) は M1-X および M2-X のリンク長
- \( e \) は X-E のリンク長
- 点\( E \) は 引数として与えられる 


## 方針
\(B1-M1-E\) を2節リンクとみなして \(M1\) を計算します。
点Eを中心にした半径(e+m)の円と、点B1を中心にした半径(b)の円の交点2つがM1の候補です。
\(M1_1 - E\) の線分の上、Eからeの距離の位置に\(X_1\)
\(M1_2 - E\) の線分の上、Eからeの距離の位置に\(X_2\)
これで、M1の候補が出そろいます。

点\(X_1\)を中心にした半径mの円と、点\(B2\)を中心とした半径bの円の交点2つがM2の候補です。これを\(M2_1,M2_2\)とします。
点\(X_2\)を中心にした半径mの円と、点\(B2\)を中心とした半径bの円の交点2つがM2の候補です。これを\(M2_3,M2_4\)とします。

候補が出そろったところで、凸形状チェックを行います。

+ \(B1,M1_1,X_1,M2_1,B2\)
+ \(B1,M1_1,X_1,M2_2,B2\)
+ \(B1,M1_1,X_2,M2_3,B2\)
+ \(B1,M1_1,X_2,M2_4,B2\)

この4つの組み合わせで5角形の凸形状チェックを行い、合格した組み合わせを採用します。
その後、B1-M1,B2-M2の成す角度も求めます。


## 計算式

### 1. 点 \( M1 \) の計算

点 \( M1 \) は、次の手順で計算されます。

1. **\( B1 \) を中心に半径 \( b \) の円と、点 \( E \) を中心に半径 \( e + m \) の円の交点を計算します。**
   - 点 \( B1 = (B1_x, B1_y) \)
   - 点 \( E = (E_x, E_y) \)
   - 半径 \( b \) の円の方程式:
     \[
     (x - B1_x)^2 + (y - B1_y)^2 = b^2
     \]
   - 半径 \( e + m \) の円の方程式:
     \[
     (x - E_x)^2 + (y - E_y)^2 = (e + m)^2
     \]
   - これらの円の交点を計算して、\( M1 \) の候補 \( M1_1 \) と \( M1_2 \) を得ます。

### 2. 点 \( X \) の計算

点 \( X \) は、点 \( E \) から距離 \( e \) の位置にあり、次の手順で計算します。

1. **点 \( M1_1 \) と \( E \) を結ぶ直線上の点 \( X_1 \) を計算します。**
   - 直線の方程式を計算し、\( E \) から距離 \( e \) の位置に \( X_1 \) を求めます。

2. **点 \( M1_2 \) と \( E \) を結ぶ直線上の点 \( X_2 \) を計算します。**
   - 同様に直線の方程式を計算し、\( E \) から距離 \( e \) の位置に \( X_2 \) を求めます。

### 3. 点 \( M2 \) の計算

点 \( M2 \) は、次の手順で計算されます。

1. **点 \( X_1 \) を中心に半径 \( m \) の円と、点 \( B2 \) を中心に半径 \( b \) の円の交点を計算します。**
   - 点 \( X_1 = (X1_x, X1_y) \)
   - 点 \( B2 = (B2_x, B2_y) \)
   - 半径 \( m \) の円の方程式:
     \[
     (x - X1_x)^2 + (y - X1_y)^2 = m^2
     \]
   - 半径 \( b \) の円の方程式:
     \[
     (x - B2_x)^2 + (y - B2_y)^2 = b^2
     \]
   - これらの円の交点を計算して、\( M2 \) の候補 \( M2_1 \) と \( M2_2 \) を得ます。

2. **点 \( X_2 \) を中心に半径 \( m \) の円と、点 \( B2 \) を中心に半径 \( b \) の円の交点を計算します。**
   - 同様に、点 \( X_2 = (X2_x, X2_y) \) と点 \( B2 \) から半径 \( m \) および \( b \) の円の交点を計算し、\( M2 \) の候補 \( M2_3 \) と \( M2_4 \) を得ます。

### 4. 凸形状チェック

1. **以下の5角形の凸形状チェックを行います:**
   - \( B1, M1_1, X_1, M2_1, B2 \)
   - \( B1, M1_1, X_1, M2_2, B2 \)
   - \( B1, M1_2, X_2, M2_3, B2 \)
   - \( B1, M1_2, X_2, M2_4, B2 \)

2. **凸形状の判定:**
   - 外積の計算式:
     \[
     \text{外積} = (b_x - a_x) \cdot (c_y - b_y) - (b_y - a_y) \cdot (c_x - b_x)
     \]
   - 凸形状であれば、全ての外積が同じ符号である必要があります。

### 5. 成角度の計算

1. **選択された組み合わせに対して、B1-M1 および B2-M2 の成す角度を計算します。**

   - 成角度 \( \theta_{B1M1} \) および \( \theta_{B2M2} \) は以下の式で計算します:
     \[
     \theta_{B1M1} = \text{atan2}(M1_y - B1_y, M1_x - B1_x)
     \]
     \[
     \theta_{B2M2} = \text{atan2}(M2_y - B2_y, M2_x - B2_x)
     \]

---

この仕様に基づいて、逆運動学の計算を進めてください。各計算式を検算し、仕様の誤りがあれば適宜修正を行ってください。